# Initializes CodeQL — IMPORTANT — comes BEFORE build
- name: Initialize CodeQL
  uses: github/codeql-action/init@v4
  with:
    languages: ${{ matrix.language }}
    build-mode: ${{ matrix.build-mode }}

# Self-healing Maven build (retrying)
- name: Build (Maven with retry)
  if: matrix.language == 'java-kotlin'
  run: |
    echo "Starting Maven build..."
    for attempt in 1 2 3; do
      echo "Attempt $attempt..."
      mvn -B -DskipTests package && break
      echo "Build failed. Retrying in 10s..."
      sleep 10
    done

# Auto repair if cache caused the failure
- name: Fix Maven Corrupted Cache
  if: failure() && matrix.language == 'java-kotlin'
  run: |
    echo "Clearing Maven cache for healing..."
    rm -rf ~/.m2/repository
    mvn -B -DskipTests package

- name: Perform CodeQL Analysis
  uses: github/codeql-action/analyze@v4
  with:
    category: "/language:${{ matrix.language }}"

# Re-run the workflow as last resort healing
- name: Self-heal on workflow failure
  if: failure()
  run: |
    echo "Self-healing: re-running workflow once..."
    gh run rerun ${{ github.run_id }}
